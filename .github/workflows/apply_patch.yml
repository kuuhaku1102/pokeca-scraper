name: Apply Scraper Patch

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ãƒ‘ãƒƒãƒã¨ã®æ•´åˆæ€§ã®ãŸã‚å±¥æ­´å…¨å–å¾—

      - name: ğŸ§© Apply patch safely
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="auto/patch-$(date +'%Y%m%d-%H%M%S')"
          git checkout -b "$BRANCH"

          echo "ğŸ§© Checking patch (3way merge)..."
          # --3way ã§è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’è©¦ã¿ã‚‹ï¼ˆç«¶åˆæ™‚ã¯ .rej ç”Ÿæˆï¼‰
          if ! git apply --3way --whitespace=fix patches/update_scrapers.patch; then
            echo "âš ï¸ Patch partially failed, continuing with .rej files"
          fi

          echo "ğŸ§© Changed files summary â†“"
          git add -A
          git diff --cached --stat || echo "No diff found"

          git commit -m "Apply patch: update_scrapers.patch" || echo "No changes to commit"

          echo "ğŸª„ Pushing to remote branch..."
          git push origin HEAD || echo "âš ï¸ Push skipped (no diff or auth issue)"
